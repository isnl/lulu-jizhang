<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¯ä»˜å®è´¦å•è§£ææµ‹è¯•</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .upload-area {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-area:hover {
            background: #f0f8f0;
        }
        .result {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .error {
            color: #f44336;
            font-weight: bold;
        }
        .stats {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ”¯ä»˜å®è´¦å•è§£ææµ‹è¯•</h1>
        
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p>ğŸ“ ç‚¹å‡»é€‰æ‹©æ”¯ä»˜å®è´¦å•CSVæ–‡ä»¶</p>
            <p style="font-size: 12px; color: #666;">æ”¯æŒGBKç¼–ç çš„CSVæ–‡ä»¶</p>
        </div>
        
        <input type="file" id="fileInput" accept=".csv" style="display: none;">
        
        <div id="result" class="result"></div>
    </div>

    <script>
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>â³ æ­£åœ¨è§£æ...</p>';
            
            try {
                const data = await file.arrayBuffer();
                
                // ä½¿ç”¨codepage 936 (GBK) è¯»å–
                const workbook = XLSX.read(data, { type: 'array', codepage: 936 });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                console.log('æ€»è¡Œæ•°:', rows.length);
                console.log('å‰5è¡Œ:', rows.slice(0, 5));
                
                // è§£ææ”¯ä»˜å®è´¦å•
                const records = parseAlipayBill(rows);
                
                // ç»Ÿè®¡
                const stats = {
                    total: records.length,
                    income: records.filter(r => r.type === 'æ”¶å…¥').length,
                    expense: records.filter(r => r.type === 'æ”¯å‡º').length,
                    totalIncome: records.filter(r => r.type === 'æ”¶å…¥').reduce((sum, r) => sum + r.amount, 0),
                    totalExpense: records.filter(r => r.type === 'æ”¯å‡º').reduce((sum, r) => sum + r.amount, 0)
                };
                
                // æ˜¾ç¤ºç»“æœ
                let html = `
                    <div class="stats">
                        <h3 class="success">âœ… è§£ææˆåŠŸï¼</h3>
                        <p>æ€»è®°å½•æ•°: ${stats.total}</p>
                        <p>æ”¶å…¥: ${stats.income} æ¡ï¼Œæ€»é¢: Â¥${stats.totalIncome.toFixed(2)}</p>
                        <p>æ”¯å‡º: ${stats.expense} æ¡ï¼Œæ€»é¢: Â¥${stats.totalExpense.toFixed(2)}</p>
                    </div>
                    
                    <h3>å‰10æ¡è®°å½•é¢„è§ˆï¼š</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>ç±»å‹</th>
                                <th>åˆ†ç±»</th>
                                <th>é‡‘é¢</th>
                                <th>å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                records.slice(0, 10).forEach(record => {
                    html += `
                        <tr>
                            <td>${record.date}</td>
                            <td style="color: ${record.type === 'æ”¶å…¥' ? '#4CAF50' : '#f44336'}">${record.type}</td>
                            <td>${record.category}</td>
                            <td>Â¥${record.amount.toFixed(2)}</td>
                            <td>${record.remark}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ è§£æå¤±è´¥: ${error.message}</p>`;
                console.error(error);
            }
        });
        
        function parseAlipayBill(rows) {
            if (rows.length < 6) {
                throw new Error('æ”¯ä»˜å®è´¦å•æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
            }
            
            const headerRow = rows[4];
            if (!headerRow || String(headerRow[0]).trim() !== 'äº¤æ˜“å·') {
                throw new Error('æ— æ³•è¯†åˆ«æ”¯ä»˜å®è´¦å•æ ¼å¼ï¼Œæœªæ‰¾åˆ°æ­£ç¡®çš„è¡¨å¤´');
            }
            
            const records = [];
            
            for (let i = 5; i < rows.length; i++) {
                const row = rows[i];
                if (!row || row.length < 11) continue;
                
                const paymentTimeRaw = row[3];
                const counterparty = String(row[7] || '').trim();
                const product = String(row[8] || '').trim();
                const amountStr = String(row[9] || '').trim();
                const direction = String(row[10] || '').trim();
                const status = String(row[11] || '').trim();
                const remark = String(row[14] || '').trim();
                
                if (status !== 'äº¤æ˜“æˆåŠŸ') continue;
                
                let type;
                if (direction === 'æ”¯å‡º') type = 'æ”¯å‡º';
                else if (direction === 'æ”¶å…¥') type = 'æ”¶å…¥';
                else continue;
                
                const amount = parseFloat(amountStr);
                if (isNaN(amount) || amount === 0) continue;
                
                let dateObj;
                if (typeof paymentTimeRaw === 'number') {
                    dateObj = new Date((paymentTimeRaw - 25569) * 86400 * 1000);
                } else {
                    dateObj = new Date(paymentTimeRaw);
                }
                
                if (isNaN(dateObj.getTime())) continue;
                const formattedDate = dateObj.toISOString().split('T')[0];
                
                const category = smartCategoryMapping(type, counterparty, product);
                const finalRemark = remark || `${counterparty} - ${product}`.substring(0, 50);
                
                records.push({
                    type,
                    category,
                    amount,
                    date: formattedDate,
                    remark: finalRemark
                });
            }
            
            return records;
        }
        
        function smartCategoryMapping(type, counterparty, product) {
            let category = type === 'æ”¯å‡º' ? 'æ—¥ç”¨å“' : 'å…¶ä»–';
            
            if (type === 'æ”¯å‡º') {
                const categoryRules = [
                    { keywords: ['ç´ å¿ƒå¾®æš–', 'ç¾å¦†', 'æŠ¤è‚¤', 'åŒ–å¦†å“'], category: 'ç¾å¦†æŠ¤è‚¤' },
                    { keywords: ['å”¯å“ä¼š', 'å¿«ä¹çš„é‹å­', 'è¡£æœ', 'æœé¥°', 'é‹'], category: 'æœé¥°' },
                    { keywords: ['å¾—åˆ°', 'çŸ¥è¯†', 'è¯¾ç¨‹', 'åŸ¹è®­', 'ä¹¦åº—'], category: 'å­¦ä¹ ' },
                    { keywords: ['ç”µå½±', 'æ¸¸æˆ', 'KTV', 'é…’å§'], category: 'å¨±ä¹' },
                    { keywords: ['å–œä¹', 'å´”å°ä¸ƒ', 'é¥°å“', 'é¦–é¥°', 'ç å®'], category: 'é¥°å“' },
                    { keywords: ['åœè½¦', 'æ‰“è½¦', 'æ»´æ»´', 'å…¬äº¤', 'åœ°é“', 'åŠ æ²¹', 'å‡ºè¡Œ', 'ä¸­å›½é“è·¯', '12306'], category: 'äº¤é€š' },
                    { keywords: ['åŒ»é™¢', 'è¯åº—', 'è¯Šæ‰€', 'ä½“æ£€', 'æŒ‚å·'], category: 'åŒ»ç–—' },
                    { keywords: ['ç¾å›¢', 'é¥¿äº†ä¹ˆ', 'å¤–å–', 'é¤é¥®', 'é¥­åº—', 'é£Ÿå ‚', 'ç›’é©¬', 'éº»è¾£', 'æ‹¼å¤šå¤šå¹³å°å•†æˆ·'], category: 'é¥®é£Ÿ' },
                    { keywords: ['äº¬ä¸œ', 'å¿«å›¢å›¢', 'è¶…å¸‚', 'ä¾¿åˆ©åº—', 'æ·˜å®', 'æ‹¼å¤šå¤š'], category: 'æ—¥ç”¨å“' },
                    { keywords: ['è¯è´¹', 'æµé‡', 'å®½å¸¦', 'ç§»åŠ¨', 'è”é€š', 'ç”µä¿¡'], category: 'é€šè®¯' },
                    { keywords: ['å® ç‰©', 'çŒ«ç²®', 'ç‹—ç²®', 'å® ç‰©åŒ»é™¢'], category: 'å® ç‰©' },
                ];
                
                for (const rule of categoryRules) {
                    if (rule.keywords.some(keyword => counterparty.includes(keyword) || product.includes(keyword))) {
                        category = rule.category;
                        break;
                    }
                }
            } else {
                const incomeRules = [
                    { keywords: ['å·¥èµ„', 'è–ªèµ„', 'è–ªé…¬', 'å…¬å¸'], category: 'å·¥èµ„' },
                    { keywords: ['æŠ•èµ„', 'ç†è´¢', 'è‚¡ç¥¨', 'åŸºé‡‘', 'åˆ†çº¢'], category: 'æŠ•èµ„æ”¶å…¥' },
                    { keywords: ['ç¨¿è´¹', 'å†™ä½œ', 'æ–‡ç« ', 'ç‰ˆç¨'], category: 'ç¨¿è´¹æ”¶å…¥' },
                    { keywords: ['çº¢åŒ…', 'ç°é‡‘å¥–åŠ±'], category: 'å…¶ä»–' },
                ];
                
                for (const rule of incomeRules) {
                    if (rule.keywords.some(keyword => counterparty.includes(keyword) || product.includes(keyword))) {
                        category = rule.category;
                        break;
                    }
                }
            }
            
            return category;
        }
    </script>
</body>
</html>
